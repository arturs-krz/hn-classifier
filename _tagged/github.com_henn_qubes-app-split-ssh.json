{
	"_id": "14366967",
	"site": "https://github.com/henn/qubes-app-split-ssh",
	"title": "Qubes Split-SSH",
	"author": "jerheinze",
	"date": "2017-06-13T13:57:07.472Z",
	"tags": {
		"categories": [
			"opensource"
		],
		"languages": [
			"shell"
		]
	},
	"content": "readme.md qubes split ssh qubes scripts allow to keep ssh private keys a separate vm (\"ssh-vault\"), allowing vms use only being authorized. is done using qubes's qrexecframework connect local ssh agentsocket an appvm the ssh agent socket within ssh-vault vm. protections the ssh private key should similar running ssh - into client appvm. was inspired the qubes split gpg. details: was developed/tested the fedora24 template qubes 3.2; might for templates appvms ssh-vault vms based debian templates, may need install nmap package the template get ncat utility. will prompted confirm each request, though split gpg won't what was requestedassumes the ssh-vault template automatically starts ssh-agent can an arbitrary number ssh-vault vms scripts default assumes ssh keys are kept an appvm named ssh-vault, though can changed modifying $ssh_vault_vm the client script.currently, single appvm only access single ssh-vault, though wouldn't hard fixsecurity note: while normal operation, user be prompted every of key, is likely possible a malicious vm hold onto ssh-agent connection more one . therefore, you authorizeusage once, assume a malicious vm then it many more times. this case, though, ssh agent should continue protect private keys; usage it be available the malicious vm until was shut down.instructionscopy files this repo various destinations (vm is first argument). can qvm-copy--vm $dest_vm filedom0: copy qubes.sshagent.policy dom0's /etc/qubes-rpc/policy/qubes.sshagenttemplate ssh vault: copy qubes.sshagent /etc/qubes-rpc/qubes.sshagent the template image the ssh vault vm. is /etc is lost every boot the vault itself, it needs be added the templateexample:# the vm the git repoqvm-copy--vm fedora-24 qubes.sshagent# the ssh-vault's template ( this case, fedora-24), run:sudo mv ~user/qubesincoming//qubes.sshagent /etc/qubes-rpc/create ssh-vault vm (default name is \"ssh-vault\" the scripts below)'s recommended disable network access this vm protect .ssh-vault: create ssh private key copy inssh-vault: copy ssh-add.desktop_ssh_vault ~user/.config/autostart/ssh-add.desktop may need create .config/autostart directory it doesn't already existexamine contents this file adjust ssh-add command the exec line desired (e.g may to pass specific ssh key add the agent)client vm: append contents rc.local_client /rw/config/rc.local is starts client side the ssh agentexamine contents set $ssh_vault_vm appropriately sure rc.local is executable. ie - chmod +x /rw/config/rc.localclient vm: append bashrc_client the client vm's ~/.bashrc sets user's $ssh_auth_sock the appropriate valueexamine contents set $ssh_vault_vm appropriatelytodoconvert client rc.local a systemd script the client template, allow ssh-vault vm be set using well-known file ( /rw/config/ssh-vault)maybe the above using qvm-service qubesdb address security note above, could ssh-add -c instead just ssh-add, though would mean user have click \"yes\" twice per access the normal case, causing fatigue/accustomization clicking yes too much.note: ssh-add -c the fedora 24 template seems be brokenanother to address above be introduce ssh agent proxy only allowed request per connection. (idea @marmarek)(possibly distant future) figure a to display info what is being signed"
}